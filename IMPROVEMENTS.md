# ShareHouseWork 改善案

2026-02-26 時点のコードベース全体レビューに基づく改善案。

---

## 1. アーキテクチャ・インフラ（優先度：高）

### 1-A. データベース移行（JSONファイル → PostgreSQL + Prisma）

**現状の問題**

- `/data/*.json` へのファイル書き込みで永続化している
- Vercel（サーバーレス）ではファイルシステムが一時的なため、デプロイ後にデータが消失する
- 同時書き込みで競合・データ破損のリスクがある

**改善案**

- Prisma + Supabase（または Neon）へ移行する
- `src/server/*-store.ts` の各ストアを Prisma Client に置き換える
- マイグレーションファイルでスキーマをバージョン管理する

**影響範囲**

- `src/server/` 配下の全ストアファイル（6ファイル）
- 全APIルート（`src/app/api/`）
- `data/` ディレクトリの廃止

---

### 1-B. 認証の実装（NextAuth.js + LINE Provider）

**現状の問題**

- `.env.example` に NextAuth 関連の変数があるが、実装がない
- 全ページが認証なしでアクセス可能
- ユーザー識別が「あなた」固定で、実際の操作者を区別できない

**改善案**

- NextAuth.js + LINE Provider を実装する
- `completedBy`・`purchasedBy`・`postedBy` を実際のログインユーザーに紐付ける
- 未認証時はログイン画面へリダイレクトする

**影響範囲**

- `src/app/layout.tsx`（SessionProvider 追加）
- 全APIルート（セッション検証の追加）
- 全フォームモーダル（ユーザー名の自動取得）

---

## 2. コード品質（優先度：高）

### 2-A. ダッシュボードのモックデータ除去

**現状の問題**

- `src/features/home/mock/dashboard-data.ts` でハードコードされた日付・データを使用中
- 実APIは実装済みなのに、ホーム画面が接続されていない

**改善案**

- ダッシュボードの各ウィジェットを実APIに接続する
- `src/features/home/mock/` を削除する

**影響範囲**

- `src/app/page.tsx`
- `src/components/ContributionWidget.tsx`
- `src/components/RecentTasksWidget.tsx`
- `src/components/ExpenseWidget.tsx`
- `src/components/NoticesWidget.tsx`

---

### 2-B. APIのHTTPメソッド設計

**現状の問題**

- 削除・キャンセル操作が `POST` で実装されている（例: `POST /api/expenses/[id]`）
- RESTful な慣例から外れており、意図が読みにくい

**改善案**

- 削除: `DELETE /api/expenses/[id]`
- キャンセル: `PATCH /api/task-completions/[id]`（部分更新）
- 更新: `PUT` または `PATCH`

**影響範囲**

- `src/app/api/` 配下の全 `[id]/route.ts`
- 各画面の `fetch` 呼び出し

---

### 2-C. テスト戦略の強化

**現状の問題**

- テストはドメインロジック中心（7ファイル）で、APIルートやコンポーネントのテストがない
- CI連携がなく、PRマージ前の品質ゲートがない

**改善案**

- APIルートの統合テストを追加する
- GitHub Actions で `npm test` と `npm run build` を自動実行する
- カバレッジ計測を導入する

---

## 3. 機能的な改善（優先度：中）

### 3-A. ハウスルール画面の実装 →完了

**現状の問題**

- `Overview.md` の画面構成に `/rules` が記載されているが、未実装
---

### 3-B. 買い物リストのアーカイブ機能

**現状の問題**

- 購入済みアイテムがリストに残り続け、リストが肥大化する

**改善案**

- 購入済みアイテムを一定期間後に自動非表示にする、または「アーカイブ」ボタンを追加する
- 「購入済みを表示 / 非表示」のトグルを設ける

---

### 3-C. 費用管理のカテゴリ別集計強化

**現状の問題**

- `ExpenseCategoryChart` コンポーネントは存在するが、活用が薄い

**改善案**

- 月次レポート画面でカテゴリ別の推移グラフを表示する
- 前月比や年間推移の可視化を追加する

---

### 3-D. CSVエクスポートの完成

**現状の問題**

- `/api/exports/monthly.csv` のエンドポイントはあるが、不完全

**改善案**

- タスク完了・費用・買い物の全データを月次CSVとしてエクスポートできるようにする
- 設定画面のエクスポートボタンと接続する

---

## 4. UX・デザイン（優先度：中）

### 4-A. ローディング状態の統一

**現状の問題**

- API呼び出し時のローディング表示がページによって不統一

**改善案**

- 共通の `<Loading />` コンポーネントを作成する
- 初回表示に Skeleton UI を導入する

---

### 4-B. エラーハンドリングのUI

**現状の問題**

- API失敗時のユーザーフィードバックが不足しており、サイレント失敗の可能性がある

**改善案**

- トースト通知コンポーネントを導入し、操作の成功・失敗をフィードバックする
- ネットワークエラー時のリトライUIを追加する

---

### 4-C. PWA対応

**現状の問題**

- スマホ中心の利用想定だが、PWA設定がない

**改善案**

- `manifest.json` を追加してホーム画面への追加を可能にする
- Service Worker でオフライン時の基本表示を確保する

---

### 4-D. ダークモード（優先度：低）

**現状の問題**

- Tailwind CSS の `dark:` バリアントが未活用

**改善案**

- `prefers-color-scheme` に応じた自動切り替えを実装する
- 優先度は低いため、他の改善完了後に検討

---

## 5. セキュリティ・運用（優先度：高）

### 5-A. API入力バリデーションの統一

**現状の問題**

- バリデーション関数は存在するが、全APIルートで一貫して使われているか不明確

**改善案**

- zod を導入し、全APIルートでスキーマバリデーションを統一する
- バリデーションエラー時のレスポンス形式を共通化する

---

### 5-B. レートリミット

**現状の問題**

- 認証なしの公開APIにレートリミットがない

**改善案**

- Vercel Edge Middleware でIPベースのレートリミットを実装する
- 認証実装後はユーザー単位のリミットに切り替える

---

### 5-C. 環境変数の整理

**現状の問題**

- `.env.example` の内容と実装状況にズレがある（`DATABASE_URL` は未使用など）

**改善案**

- 実装に合わせて `.env.example` を最新化する
- 新しい環境変数追加時は必ず `.env.example` も更新する（CLAUDE.md のルール通り）

---

## 6. 開発体験（優先度：低〜中）

### 6-A. Linter・Formatter 設定の強化

**現状の問題**

- `eslint-config-next` のみで、独自ルールがない

**改善案**

- `@typescript-eslint/strict` を追加する
- Prettier を導入してコードスタイルを統一する

---

### 6-B. Next.js 設定の活用

**現状の問題**

- `next.config.ts` が空のまま

**改善案**

- 画像最適化、セキュリティヘッダー、リダイレクト等を必要に応じて設定する

---

## 推奨する着手順序

| 順番 | 項目 | 理由 |
|:---:|------|------|
| 1 | 1-A. DB移行 | Vercelデプロイに必須。全機能の基盤 |
| 2 | 1-B. 認証実装 | ユーザー識別なしでは実運用不可 |
| 3 | 2-A. ダッシュボード実API接続 | モック除去で実データが反映される |
| 4 | 5-A. バリデーション統一 | DB移行と同時に整備すると効率的 |
| 5 | 2-B. HTTPメソッド設計修正 | DB移行のタイミングでAPI全体を見直す |
| 6 | 3-A. ハウスルール画面 | Overview記載の未実装機能 |
| 7 | 4-A〜B. ローディング・エラーUI | UX品質の底上げ |
| 8 | 2-C. テスト・CI整備 | 機能追加前に品質ゲートを確立 |
| 9 | 4-C. PWA対応 | スマホ利用体験の向上 |
| 10 | 残りの項目 | 運用開始後にフィードバックを見て判断 |
