# ShareHouseWork - Overview

## 1. プロダクト概要
ShareHouseWork は、4人暮らしのシェアハウス向け生活管理アプリです。
家事・共益費・お知らせを一元管理し、LINE連携で日々の運用負荷を下げることを目的とします。

### 解決したい課題
- 誰が何をやったかが曖昧になりやすい
- 共益費の残高と支出が見えづらい
- 連絡がチャットに埋もれて重要事項が伝わりにくい

### スコープ
- 対象: 共益費の管理、家事管理、買い物、ルール、お知らせ
- 非対象: 家賃の徴収管理（アプリ外運用）

---

## 2. 想定ユーザーと運用条件

### ユーザー
- シェアハウスメンバー 4人

### 利用環境
- デバイス: スマートフォン / PC（レスポンシブ）
- 認証: LINEログイン（OAuth）

### 費用前提（現行）
| メンバー | 家賃 | 共益費（月額） | 備考 |
|---|---:|---:|---|
| 家主 | - | ¥15,000 | 管理者候補 |
| 家主のパートナー | - | ¥15,000 | |
| 友達1 | ¥60,000 | ¥15,000 | |
| 友達2 | ¥65,000 | ¥15,000 | |

- 共益費内訳: 水道・電気・ガス、消耗品、食費の一部
- 共益費金額は設定で変更可能

---

## 3. 機能要件（整理版）

### 3.1 家事管理
- タスク一覧表示（カテゴリ別）
- 担当固定なしで完了報告
- 同日・同一タスクの複数完了記録
- 完了履歴（誰が・いつ）
- タスク追加/編集/削除（管理権限で制御）
- タスク単位ポイント
- 貢献度表示（過去30日）
- LINEからの完了報告

### 3.2 費用管理（共益費のみ）
- 月次の定額拠出設定
- 支出記録（品目・金額・日付・購入者）
- 月次残高表示（拠出合計 - 支出合計）
- 支出履歴表示

### 3.3 ハウスルール
- ルール文書の作成/編集/閲覧
- カテゴリ管理
- 更新履歴

### 3.4 買い物リスト
- アイテム追加（品名・数量・メモ）
- 購入済みチェック（購入者記録）
- 完了アイテムのアーカイブ

### 3.5 お知らせ・通知
- お知らせ投稿/閲覧
- LINE通知（家事完了、買い物追加、お知らせ投稿）

---

## 4. 非機能要件
- レスポンシブUI（スマホ優先）
- 低学習コスト（直感操作）
- ハウス単位データ分離（将来の複数ハウス対応）
- 主要画面の体感高速性（初回表示・操作遅延を最小化）

---

## 5. 技術スタック
| レイヤー | 採用技術 |
|---|---|
| Framework | Next.js (App Router) + TypeScript |
| Styling | Tailwind CSS |
| DB | PostgreSQL + Prisma ORM |
| Auth | NextAuth.js (LINE Provider) |
| Notification | LINE Messaging API |
| Hosting | Vercel + Supabase / Neon |

---

## 6. 現状実装ステータス（2026-02-25時点）
- ホームダッシュボードUIは実装済み（モックデータ中心）
- 貢献度グラフ、急ぎの家事、費用残高、お知らせのウィジェット表示あり
- 完了報告FABはUIのみで、永続化/API連携は未実装
- 優先度計算ロジックは存在するが、境界条件の改善余地あり

---

## 7. 改善点（機能・デザイン・品質）

### 7.1 機能改善
1. 家事完了フローの本実装
- 完了API、履歴保存、失敗時リトライ、二重送信防止を実装

2. 優先タスク算出の精度向上
- overdue計算を厳密化し、未完了タスクの優先度補正を導入

3. 費用表示の安全化
- 使用率計算で `0除算` と `100%超過` をガード

4. 通知の最適化
- 全通知ではなく、期限超過/重要連絡/残高閾値に絞った通知設定を追加

### 7.2 デザイン改善
1. FABモーダルの再設計
- 現状の「右下1/4固定」から、モバイルは全幅ボトムシートへ変更

2. 画面上部の優先情報集約
- 「今日やること」「残高アラート」「新着通知」をファーストビューに統合

3. UIトークン統一
- urgent/warn/ok の色・バッジ・アイコン規約を共通化

4. アクセシビリティ改善
- キーボード操作、フォーカス可視化、読み上げラベルを整備

### 7.3 技術品質改善
1. 型の厳密化
- 金額・ポイント・日時の型を強化し、不正値流入を抑制

2. テスト整備
- 優先度計算、費用計算、時刻表示のユニットテスト追加

3. ロジック分離
- 画面ロジックをドメイン層へ寄せ、UIコンポーネントを薄く保つ

---

## 8. 実装ロードマップ

### Phase 1: 基盤安定化（1-2週間）
- 家事完了API実装（保存/取得）
- 使用率計算のガード実装
- 優先度計算ロジック修正
- 最低限のユニットテスト追加

完了条件:
- 完了報告がDBに保存される
- 優先度計算の主要ケースでテストが通る
- 残高ウィジェットが異常値で崩れない

### Phase 2: UX改善（2-3週間）
- FABをモバイル最適のボトムシートに刷新
- ホームの情報優先順位を再構成
- 通知設定（ON/OFF・重要通知のみ）追加
- アクセシビリティ調整

完了条件:
- 完了報告操作が3ステップ以内
- 主要UIでキーボード操作が成立
- 通知粒度をユーザーが選択可能

### Phase 3: 実運用機能（2-4週間）
- LINE連携の本接続（完了報告/通知）
- 履歴・監査ログ・CSVエクスポート
- ルール・買い物・お知らせ各画面の編集体験改善

完了条件:
- LINE経由のイベントが双方向で反映
- 月次運用データをエクスポート可能
- 操作ログで変更追跡ができる

### Phase 4: 差別化機能（継続）
- 公平性を意識した貢献スコア設計
- 月末残高予測、異常支出アラート
- 複数ハウス対応に向けたマルチテナント設計

---

## 9. Phase 1 Issue分解（実装タスク）

### Issue 1: 家事完了API（POST / GET）を実装
- 目的: 完了報告を永続化し、履歴表示の基盤を作る
- 作業:
- 完了報告作成API（taskId, completedBy, completedAt, source）を追加
- 完了履歴取得API（期間指定・件数制限）を追加
- バリデーション（必須項目、存在しないtaskId拒否）を実装
- 受け入れ条件:
- 正常系でDB保存される
- 不正入力時に `4xx` を返す
- 履歴が新しい順で返る
- 依存: なし

### Issue 2: 完了報告FABをAPI連携
- 目的: UIモックを実運用フローに置き換える
- 作業:
- `TaskCompleteFAB` から Issue 1 のAPIを呼び出し
- 送信中状態、二重送信防止、失敗時トーストを実装
- 成功時にUIを即時更新（楽観更新 or 再取得）
- 受け入れ条件:
- 1タップで完了報告が保存される
- 連打しても二重登録されない
- エラー時にユーザーが再試行できる
- 依存: Issue 1

### Issue 3: 優先度計算ロジック修正
- 目的: 「急ぎの家事」表示の信頼性を上げる
- 作業:
- `overdueDays` の丸め処理を見直し（境界日での誤判定防止）
- 未完了タスク（lastCompletedAt=null）の優先度補正を明確化
- 並び順ルール（同率時のtie-break）を定義
- 受け入れ条件:
- 期限境界（当日/前日/翌日）で期待通りの表示
- 未完了タスクが優先表示される
- ソート結果が決定的（毎回同じ）になる
- 依存: なし

### Issue 4: 費用使用率計算のガード実装
- 目的: 残高ウィジェットの表示崩れと異常値を防ぐ
- 作業:
- `totalContributed=0` 時の表示ルール追加
- 使用率を `0-100` にクランプ
- 負値や異常値が入った場合のフォールバック表示追加
- 受け入れ条件:
- 0除算が発生しない
- バー幅が常に `0-100%` に収まる
- 異常データでも画面が崩れない
- 依存: なし

### Issue 5: ドメインロジックのユニットテスト追加
- 目的: 回帰を防ぎ、リファクタリング耐性を上げる
- 作業:
- 優先度計算テスト（期限超過/当日/未完了/同率）
- 費用計算テスト（0除算、上限クランプ、正常系）
- 相対時刻フォーマットの境界テスト
- 受け入れ条件:
- 主要ケースのテストがすべて通る
- 失敗時に原因が分かるテスト名になっている
- 依存: Issue 3, Issue 4

### Issue 6: 型の厳密化（最小範囲）
- 目的: 不正値混入をコンパイル時に減らす
- 作業:
- 金額・ポイントの型表現を見直し（少なくとも `number` の意味を明確化）
- API入出力型を `src/types` に集約
- `null/undefined` の取り扱いを明示
- 受け入れ条件:
- 主要APIとUIの型不整合が解消
- 型定義変更後もビルドが通る
- 依存: Issue 1, Issue 2

### Issue 7: Phase 1 完了確認と軽量ドキュメント更新
- 目的: Phase 2 に進む前の品質ゲートを固定化
- 作業:
- 完了条件チェックリストを作成
- 実装済みAPI、既知制約、次フェーズ持ち越し事項を記録
- 受け入れ条件:
- チェックリストが全項目 `Done` になっている
- 持ち越し項目が明文化されている
- 依存: Issue 1-6

### 実装順序（推奨）
1. Issue 1
2. Issue 3
3. Issue 4
4. Issue 2
5. Issue 5
6. Issue 6
7. Issue 7

### Phase 1 完了レポート（2026-02-25）

#### チェックリスト
- [x] 完了報告API（POST/GET）が実装され、`taskId` 検証と `4xx` エラー応答がある
- [x] 完了報告FABがAPI連携され、送信中状態・二重送信防止・失敗時再試行が可能
- [x] 優先度計算ロジックが境界日を考慮し、同率時に決定的な並び順を持つ
- [x] 費用使用率が `0除算回避` と `0-100クランプ` を満たす
- [x] ユニットテスト（優先度/費用/時刻境界）が追加され、`npm test` で全件成功
- [x] API入出力・金額・ポイント・日時の意味型が `src/types` に集約されている

#### 実装済みAPI
- `POST /api/task-completions`
- `GET /api/task-completions?from=&to=&limit=`
- 永続化先: `data/task-completions.json`（暫定ファイルストア）

#### 既知制約
- 永続化はDBではなくローカルJSONファイルのため、同時書き込み耐性と運用耐久性が限定的
- `npm run build` はネットワーク制限下で Google Fonts 取得に失敗する場合がある
- `npm test` は成功するが、Node実行時に `MODULE_TYPELESS_PACKAGE_JSON` 警告が出る

#### Phase 2 以降への持ち越し
- 永続化基盤を Prisma + PostgreSQL へ移行し、競合制御を導入
- FABをモバイル最適の全幅ボトムシートへ刷新
- 通知設定UI（重要通知のみ/ON-OFF）とアクセシビリティ強化を実装
- テストをCI実行へ組み込み、ビルド・テスト品質ゲートを自動化

---

## 10. KPI（運用開始後に計測）
- 家事完了報告率（目標: 週次で継続増）
- タスク期限超過率（目標: 逓減）
- 月次残高の予測誤差（目標: 小さく維持）
- 重要通知の閲覧率（目標: 高水準維持）

---

## 11. 画面構成
```
/                - ホーム（ダッシュボード）
/tasks           - 家事管理
/expenses        - 費用管理
/rules           - ハウスルール
/shopping        - 買い物リスト
/notices         - お知らせ
/settings        - 設定（通知・共益費・権限）
```
