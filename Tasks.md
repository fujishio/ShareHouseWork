# Tasks.md — 家事管理システム 詳細設計

## 概要

フリー制（担当固定なし）のタスク管理システム。
誰でも任意のタスクを完了でき、完了者にポイントが付与される。
貢献度は過去30日間のスライドウィンドウで集計する。

---

## タスク一覧（初期データ）

### カテゴリ: キッチン

| タスク名 | ポイント | 頻度目安 | 備考 |
|--------|---------|---------|------|
| | | | |
| 生ゴミ入れの交換 | 1pt | 毎日 |  |
| 流し台の洗い物・片付け | 2pt | 毎日 | 食器・調理器具 |
| コンロ周りの掃除 | 2pt | 週2〜3回 | 油汚れ含む |
| シンク洗い | 3pt | 週1回 | 排水溝ネット交換含む |
| 換気扇フィルター掃除 | 5pt | 月1回 | |

### カテゴリ: 浴室・洗面所

| タスク名 | ポイント | 頻度目安 | 備考 |
|--------|---------|---------|------|
| 浴室掃除（床・浴槽） | 3pt | 週1〜2回 | |
| 浴室排水口の掃除 | 3pt | 週1回 | |
| 洗面所の掃除 | 2pt | 週1〜2回 | 鏡・洗面台 |
| トイレ掃除 | 3pt | 週1〜2回 | |

### カテゴリ: リビング・共用部

| タスク名 | ポイント | 頻度目安 | 備考 |
|--------|---------|---------|------|
| リビングの掃除機がけ | 2pt | 週1〜2回 | |
| リビングの拭き掃除 | 2pt | 週1回 | |
| 廊下・玄関の掃除機がけ | 2pt | 週1回 | |

### カテゴリ: ゴミ出し

| タスク名 | ポイント | 頻度目安 | 備考 |
|--------|---------|---------|------|
| 燃えるゴミ出し | 1pt | 週2回（月・木など） | 収集日に合わせて |
| 資源ゴミ出し（ペットボトル・缶など） | 1pt | 週1回 | |
| ゴミ袋の補充 | 1pt | 随時 | |

### カテゴリ: 洗濯・その他

| タスク名 | ポイント | 頻度目安 | 備考 |
|--------|---------|---------|------|
| 共用タオル・バスマットの洗濯 | 2pt | 週1〜2回 | |
| 消耗品の買い出し（補充） | 2pt | 随時 | トイレットペーパー等 |

---

## ポイントシステム

### ポイント付与ルール

- タスクを完了した人に、そのタスクのポイントが即時付与される
- **同日・同タスクで複数人が完了した場合、全員にポイントが付与される**

### ポイントの集計・表示

- 集計期間：**過去30日間のスライドウィンドウ**（当日を含む30日分）
- 表示場所：
  - ホーム（簡易版）: 円グラフ + 自分のポイントと順位
  - /tasks（詳細版）: 円グラフ + 全員の内訳 + 合計完了タスク数

### 取り消し後のポイント処理

- 完了報告が取り消された場合、付与されたポイントは**即時剥奪**される
- 貢献度グラフ・ランキングも即時再計算される

### ポイントのリセット・履歴

- ポイントはリセットしない（30日スライドで自動的に古い分が除外される）
- 完了履歴はすべてDBに保存し、将来の参照・集計に対応
- **取り消された完了記録も削除せず保持する**（誰が・いつ・なぜ取り消したかを記録）

---

## タスクの状態と表示

### タスクカードの表示情報

```
┌──────────────────────────────────────┐
│ 浴室掃除（床・浴槽）          +3pt   │
│ 最終完了: Aさん 2日前                 │
│                         [完了する]    │
└──────────────────────────────────────┘
```

- **タスク名**
- **ポイント値**（`+Xpt` 形式）
- **最終完了者と日時**（「X日前」または「今日 HH:MM」形式）
  - 本日すでに自分が完了済みの場合：ボタンを「完了済み」に変更しグレーアウト
  - 本日誰かが完了済みの場合：最終完了者を表示しつつボタンは有効のまま（自分もできる）
- **完了ボタン**

### 完了時のフィードバック

1. ボタンタップ → ローディング表示
2. 記録成功 → アニメーション（✓マーク + ポイント獲得エフェクト）
3. トースト通知：`浴室掃除を完了しました！ +3pt`
4. タスクカードの最終完了者が即時更新

### タスクのソート順

デフォルト: カテゴリ順 → カテゴリ内は手動並び替え可能（管理者）

---

## 完了履歴・取り消し機能

### 完了履歴画面（/tasks/history）

全員が閲覧できる。タスク一覧画面の「履歴」タブ or リンクから遷移。

```
┌──────────────────────────────────────────────────┐
│  完了履歴                           [絞り込み ▼] │
├──────────────────────────────────────────────────┤
│ 浴室掃除（床・浴槽）  +3pt                        │
│ Aさん  今日 14:32  アプリ                         │
│                              [取り消す]           │
├──────────────────────────────────────────────────┤
│ ゴミ出し  +1pt                                    │
│ Bさん  今日 08:10  LINE                           │
│                              [取り消す]           │
├──────────────────────────────────────────────────┤
│ ~~リビング掃除機がけ  +2pt~~   ⚠️ 取り消し済み    │
│ Cさん  昨日 19:00  アプリ                         │
│ 取り消し: Dさん  昨日 19:45「やっていなかった」    │
└──────────────────────────────────────────────────┘
```

- 表示件数: 直近50件（スクロールで追加読み込み）
- 取り消し済みの記録は打ち消し線＋「⚠️ 取り消し済み」バッジで表示し、誰がいつ取り消したかも表示する
- 絞り込み: メンバー別 / タスク別 / 期間指定 / 取り消し済みのみ

### 取り消し操作フロー

1. 「取り消す」ボタンをタップ
2. 確認ダイアログを表示:
   ```
   ┌──────────────────────────────────┐
   │  完了報告を取り消しますか？       │
   │  Aさん「浴室掃除」 今日 14:32    │
   │                                  │
   │  理由（必須）:                   │
   │  ┌──────────────────────────┐   │
   │  │ ○ やっていなかった       │   │
   │  │ ○ 不完全な完了           │   │
   │  │ ○ その他                 │   │
   │  └──────────────────────────┘   │
   │  ※「その他」選択時のみ表示:     │
   │  [____________________________]  │
   │                                  │
   │      [キャンセル]  [取り消す]    │
   └──────────────────────────────────┘
   ```
   - 理由が未選択の場合「取り消す」ボタンは非活性
   - 「その他」を選択した場合、テキスト入力欄が出現（入力は任意）
3. 確定 → DBの `cancelledAt` / `cancelledBy` / `cancelReason` / `cancelReasonNote` を更新、ポイント剥奪
4. 完了履歴の該当レコードが「取り消し済み」表示に変わる
5. LINE通知（任意）: `Aさんの浴室掃除の完了記録がBさんによって取り消されました`

### 取り消しの権限と制限

- **取り消しは全員が可能**（管理者限定にしない）
- 取り消し済みの記録をさらに「復元」する操作は**設けない**（復元が必要な場合は改めて「完了」を押す）
- 取り消し自体を取り消す操作も**設けない**（取り消し履歴は不変として扱う）

---

## タスクの管理（管理者機能）

> 管理者権限の有無は未確定。以下は「1人が管理者」の場合の設計。

### タスクの追加

入力項目:
- タスク名（必須・最大50文字）
- カテゴリ（プルダウン or 新規作成）
- ポイント値（1〜10pt・必須）
- 頻度メモ（任意・表示用テキスト）

### タスクの編集

- タスク名・カテゴリ・ポイント値・頻度メモを変更可能
- ポイント値を変更した場合、**過去の完了履歴には遡及しない**（変更以降の完了から新しいポイントが適用）

### タスクの削除

- 削除時は確認ダイアログを表示
- 過去の完了履歴は残す（soft delete: `deleted_at` タイムスタンプで管理）
- 削除済みタスクは一覧から非表示になるが、履歴・集計には引き続き反映

### カテゴリの管理

- カテゴリの追加・名前変更・削除
- カテゴリ削除時: 配下のタスクを「未分類」に移動 or 一括削除を選択

---

## LINEリッチメニュー連携

### 選定タスク（6枠・暫定案）

```
┌─────────────┬─────────────┐
│  ゴミ出し   │  キッチン   │
│   完了      │   完了      │
├─────────────┼─────────────┤
│  浴室掃除   │  リビング   │
│   完了      │   掃除完了  │
├─────────────┼─────────────┤
│  トイレ掃除 │  アプリを   │
│   完了      │   開く      │
└─────────────┴─────────────┘
```

> ※ 最大6枠は決定事項。具体的なタスク選定は未確定（CLAUDE.md 未決事項参照）。
> 上記は叩き台として記載。管理者が設定画面から変更可能にする。

### LINE完了フロー

```
ユーザー操作          LINE Bot                    アプリ
─────────────────────────────────────────────────────────
リッチメニュータップ
  │
  └──→ Postbackイベント送信 ──→ Webhook受信
                                  │
                                  ├── ユーザー識別（LINE ID → メンバー）
                                  ├── タスク完了をDBに記録
                                  ├── ポイント付与
                                  └── LINE返信送信 ──→「✅ 浴室掃除を記録しました！ +3pt」
                                       │
                                       └── グループ通知 ──→「AさんがXXを完了しました」
```

### Webhook メッセージ仕様

- **Postback data 形式:** `action=complete_task&task_id={taskId}`
- **エラーケース:**
  - 未登録のLINEユーザー: `このLINEアカウントはアプリに登録されていません。` と返信
  - 同日すでに完了済み: `本日すでに記録済みです。（Xさんが完了済み）` と返信
  - サーバーエラー: `記録に失敗しました。アプリから再度お試しください。` と返信

---

## データモデル（Prisma Schema 案）

```prisma
enum CancelReason {
  FALSE_REPORT   // やっていなかった
  INCOMPLETE     // 不完全な完了
  OTHER          // その他
}

model TaskCategory {
  id        Int      @id @default(autoincrement())
  name      String   // "キッチン", "浴室・洗面所" など
  order     Int      @default(0) // 表示順
  houseId   Int
  house     House    @relation(fields: [houseId], references: [id])
  tasks     Task[]
  createdAt DateTime @default(now())
}

model Task {
  id          Int           @id @default(autoincrement())
  name        String        // "浴室掃除（床・浴槽）"
  points      Int           // 1〜10
  frequencyNote String?     // "週2〜3回" などの表示用テキスト
  order       Int           @default(0) // カテゴリ内表示順
  categoryId  Int
  category    TaskCategory  @relation(fields: [categoryId], references: [id])
  houseId     Int
  house       House         @relation(fields: [houseId], references: [id])
  completions TaskCompletion[]
  deletedAt   DateTime?     // soft delete
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model TaskCompletion {
  id             Int       @id @default(autoincrement())
  taskId         Int
  task           Task      @relation(fields: [taskId], references: [id])
  userId         Int
  user           User      @relation(fields: [userId], references: [id])
  pointsEarned   Int       // 完了時のポイント値を記録（後からタスクのpt変更があっても履歴は不変）
  completedAt    DateTime  @default(now())
  source         String    @default("app") // "app" | "line"

  // 取り消しフィールド（null = 有効な完了記録）
  cancelledAt      DateTime? // 取り消し日時
  cancelledById    Int?      // 取り消したメンバーのID
  cancelledBy      User?     @relation("CancelledCompletions", fields: [cancelledById], references: [id])
  cancelReason     CancelReason? // 取り消し理由（選択式）
  cancelReasonNote String?   // 「その他」選択時の自由記述（任意）

  @@unique([taskId, userId, completedAt]) // 同日同タスク同ユーザーの重複防止はアプリレイヤーで制御
}
```

---

## API エンドポイント（Next.js Route Handlers）

| メソッド | パス | 説明 |
|--------|------|------|
| GET | `/api/tasks` | タスク一覧取得（カテゴリ込み） |
| POST | `/api/tasks` | タスク新規作成（管理者のみ） |
| PATCH | `/api/tasks/[id]` | タスク編集（管理者のみ） |
| DELETE | `/api/tasks/[id]` | タスク削除 soft delete（管理者のみ） |
| POST | `/api/tasks/[id]/complete` | タスク完了記録 |
| GET | `/api/tasks/completions` | 完了履歴取得（全員・ページネーション付き） |
| DELETE | `/api/tasks/completions/[completionId]` | 完了報告の取り消し（全員が可能） |
| GET | `/api/tasks/contributions` | 過去30日の貢献度サマリー取得（取り消し済みを除外） |
| GET | `/api/categories` | カテゴリ一覧取得 |
| POST | `/api/categories` | カテゴリ新規作成（管理者のみ） |
| PATCH | `/api/categories/[id]` | カテゴリ編集（管理者のみ） |
| DELETE | `/api/categories/[id]` | カテゴリ削除（管理者のみ） |
| POST | `/api/line/webhook` | LINE Webhook受信 |

---

## 未確定事項

- [ ] LINEリッチメニューの6枠に載せる具体的なタスク（上記は暫定案）
- [ ] 管理者権限: 全員同権 vs 1人（家主）が管理者
  - 全員同権の場合、タスク追加・削除・編集を全員が可能にする
- [ ] 「頻度目安」をUI上でどこまで活用するか（表示のみ？リマインダー通知？）
- [ ] 未完了タスクのリマインダー通知（例: 「ゴミ出しがX日間誰もやっていません」）
- [ ] ポイントランキングの表示形式（順位バッジ、週間MVP など）
